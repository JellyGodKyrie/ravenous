var object,
	amount,
	credits_available;
$('#myModal').on('shown.bs.modal', function () {
	$('#myModal').on('click', '.highlighted-display-option', function (e) {
		e.preventDefault();
		var object_id = $(this).data("id");

		$.ajax({
			url:"/modAnnonces/ajax/get_highlighted_display_options.php",
			type:'POST',
			dataType:"json",
			data: 'ad='+ $('[name=ad]').val()
		}).done(function(data) {
			$("#highlighted-display-option-form").html(data['html']);
			$('#myModal')
  				.modal('hide')
  				.on('hidden.bs.modal', function (e) {
  					$("#highlighted-option-modal #form-messages").html('');
  					$('#highlighted-option-modal input[name=object_id]').val(object_id);
  					showModal($('#highlighted-option-modal'));
  				});
		}).fail(function(jqXHR, textStatus, errorThrown){
			alert(errorThrown);
		});
	});

	$(this).off('shown.bs.modal');
});

$('#highlighted-option-modal').on('shown.bs.modal', function () {
	$('#highlighted-option-modal').on('click', '#highlighted-display-option-submit', function(e) {
		e.preventDefault();

		var form = $('#highlighted-display-option-form');
		var formData = $(form).serialize();

		$.ajax({
			url: $(form).attr('action'),
			type: 'POST',
			dataType:"json",
			data: formData
		}).done(function(data) {
			$("#highlighted-option-modal #form-messages").html(data.message);

			if (data.error) {
				if (data.credits_available == false) {
					amount = data.amount;
					credits_available = data.credits_available;

					window.setTimeout(function(){
		                 $('#highlighted-option-modal')
			  				.modal('hide')
			  				.on('hidden.bs.modal', function (e) {
			  					if ( typeof(amount) != 'undefined' && amount != null && credits_available == false ) {
			  						$('#online-paiement-display-info-message').addClass('alert alert-info').html("Votre précedente opération coûte " + amount).fadeIn();
			  					}
			  					showModal($('.online_paiement_modal'));
			  				});
		            }, 3000);
				}
			} else {
				window.setTimeout(function(){
	                $('#highlighted-option-modal').modal('hide'); 
	            }, 3000);

				window.setTimeout(function(){
	                window.location.reload(true);
	            }, 5000);
			}

		}).fail(function(jqXHR, textStatus, errorThrown){
			alert(errorThrown);
		});
	});

	$(this).off('shown.bs.modal');
});

$('.online_paiement_modal').on('click', '.btn-submit-payment-valid', function (e) {
	var data = $('#form-pay-online').serializeArray();

	if ( typeof(amount) != 'undefined' && amount != null && credits_available == false ) {
		data.push({
			name: "amount",
			value: amount
		});
	}

	if ( typeof(credits_available) != 'undefined' && credits_available == false ) {
		data.push({
			name: "credits_available",
			value: credits_available
		});
	}

	if (CheckPaiementForm()) {
		$.ajax({
		    type: 'POST',
		    url: '/modPaydunya/required_credit_payment_pdunya.php',
		    data: $.param( data, true ),
		    dataType: 'json'
		}).done(function(data) {

			if (data.error) {
				$('#online-paiement-display-message').addClass('alert alert-danger').html(data.message).fadeIn();
				window.setTimeout(function(){
	                $('#online-paiement-display-message').fadeOut();
	            }, 5000);

	            window.setTimeout(function(){
	                $('.online_paiement_modal').modal('hide'); 
	            }, 2000);
			} else {
				$('#online-paiement-display-message').addClass('alert alert-success').html(data.message).fadeIn();
				window.setTimeout(function(){
	                $('#online-paiement-display-message').fadeOut();
	            }, 5000);

	            window.setTimeout(function() {
	            	window.location.href = data.redirectUrl;
	            }, 2000);
			}
		}).fail(function(jqXHR, textStatus, errorThrown){
			alert(errorThrown);
		});
	}
});

$('.online_paiement_modal').on('click', '.btn-group > .btn', function (e) {
	$(this).removeClass("active");
	$(this).addClass("active");
    $('#unit_price').val($(this).val());
    $('#name').val("Forfait "+ $(this).text());
    $('#packageId').val($(this).data('id'));
    $('#alert-container').fadeOut();
    $('#package-details').html('<div class="row"><div class="col-sm-12 col-xs-12">Coût du paiement en ligne : <strong>' + $(this).val() + '</strong> fcfa <br> Avec le paiement en ligne, votre compte est crédité automatiquement !</div></div>');
});

$('.online_paiement_modal').on('click', '.btn-submit-payment', function (e) {
	$('#payment_methode').val($(this).data('payment-method'));
});

function testWalletInfos(a, w) {
	if(a > w){
		$('#displayer').html('<div class="alert alert-danger" role="alert"><span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span><span class="sr-only">Error:</span>D&eacute;sol&eacute;, vous ne disposez pas d&apos;assez de cr&eacute;dits. Pour souscrire &agrave; cette option, veuillez acheter du cr&eacute;dit</div>').fadeIn();
		window.setTimeout(function() {
            $('displayer').fadeOut();
        }, 5000);

        window.setTimeout(function(){
			$('#myModal')
  				.modal('hide')
  				.on('hidden.bs.modal', function (e) {
  					showModal($('.online_paiement_modal'));
  				});
        }, 3000);

		return false
	} else {
		$('#displayer').html('')
		return true
	}
}

function CheckPaiementForm() {
	var packageId = $('#packageId').val();
	var userId = $('#userID').val();
	var paiementMethod = $('#payment_methode').val();
	var warnings = [];

	if (!$.trim(packageId)) {
        warnings.push("- Veuillez choisir un forfait. ");
    }

    if (!$.trim(userId)) {
        warnings.push("- Veuillez vous connecter pour continuer. ");
    }

    if (!$.trim(paiementMethod)) {
        warnings.push("- Veuillez choisir un moyen de paiement. ");
    }

	if (warnings.length > 0)
        alert(warnings.join("\n"));

    return warnings.length == 0;
}